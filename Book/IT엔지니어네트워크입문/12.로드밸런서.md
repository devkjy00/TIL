## 부하 분산이란
- 서비스의 가용성을 높이기 위해 하나의 서비스는 보통 두 대 이상의 서버로 구성
    - 각 서버 IP주소가 달라서 서비스 요청시 어떤 IP를 요청할지 결정해야 한다
    - L4, L7스위치인 로드 밸런서가 사용자별로 다수의 서버에 서비스 요청을 분산시켜 부하를 분산한다
        - 사용자는 로드 밸런서의 가상IP를 통해서 서버에 접근한다

- FWLB(FireWall Load Balancing, 방화벽 부하 분산)
    - SLB(Server Load Balancing, 서버 부하 분산)
    - 방화벽 액티브-액티브 구성을 위해 로드밸런서를 사용하기도 한다
    - 방화벽 장비를 이중화 할 경우
        - 세션 테이블에 패킷 정보가 없으면 패킷을 폐기한다
            - 이중화로 경로가 두개 이상 생겨 비대칭 경로가 생기면 이런 문제가 생긴다

        - FWLB가 세션을 인식하고 일정한 규칙으로 방화벽 세션을 분산한다
            - 하나의 세션이 하나의 방화벽만 거치도록 분산
        
        - 방화벽끼리 세션테이블을 동기화하거나 첫번째 패킷이 SYN이 아니어도 허용하는 기능등으로 장애를 해결할 수도 있다

## 분하 분산 방법
- 로드밸런서는 VIP(Virual IP)를 통해서 서비스를 제공한다
    - 서비스 IP 주소 라고도 한다

- RIP(Real IP)를 가진 각 서버는 로드 밸런서의 VIP에 바인딩된다
    - 로드밸런서에서 IP와 4계층 정보인 서비스포트를 지정해서 부하분산 그룹을 만들고 요청에 적절한 서버로 트래픽을 분산시킨다
    - 로드밸런서는 서비스 포트를 변경해서 서버와 연결시킬 수도 있다
        - VIP의 80포트로 온 요청을 RIP의 8080포트로 연결시킬수 있다
    
- 동일한 RIP에서 서비스 포트마다 VIP를 다르게 설정할 수 있고 RIP의 서비스 포트와 VIP포트도 다르게 설정할 수 있다

## 헬스 체크
- 로드밸런서는 주기적인 헬스 체크를 통해 정상적인 서비스쪽으로만 부하를 분산한다
- 헬스 체크 방식
    - ICMP
        - VIP에 연결된 서버에 대해 ICMP(ping)로 서버가 살아있는지 여부만 체크, 잘 사용되지 않는다
    
    - TCP 서비스 포트
        - 로드밸런서에서 서버에 등록한 포트로 SYN을 보내고 서버가 정상적으로 응답(SYN, ACK)하면 헬스체크를 종료(ACK,FIN)보내고 응답(ACK,FIN)을 받고 끝낸다(ACK)
    
    - TCP 서비스 포트 : Half Open
        - 정상적인 3방향 핸드셰이크보다 빠른 종료로 부하를 줄이기위해 TCP Half Open를 사용하기도 한다
        - (SYN)->(SYN,ACK)->(RST)
    
    - HTTP 상태 코드
        - 서비스 포트까지는 TCP로 정상적으로 열리지만 웹 서비스에 대한 응답에 실패할 수 있다
        - HTTP를 요청해 정상적인 상태코드(200 OK)를 응답하는지 헬스 체크를 수행할 수 있다
        
    - 콘텐츠 확인(문자열 확인)
        - 로드밸런서에서 서버로 콘텐츠를 요청, 지정된 콘텐츠를 응답했는지 확인해서 헬스 체크를 한다
            - 특정 웹페이지를 호출해 지정한 문자열이 있는지 체크하는 기능

        - 서버의 상태뿐 아니라 서버의 백엔드의 상태까지 헬스 체크를 할수 있다
        
- 헬스 체크 주기와 타이머
    - 주요 타이머 값
        - 주기(Interval) : 로드밸런서에서 서버로 헬스 체크 패킷을 보내는 주기
            - 응답시간보다 크게 설정해야 한다
        - 응답시간(Response) : 패킷을 보내고 응답을 기다리는 시간, 초과시 실패
        - 시도 회수(Retries) : 헬스 체크 실패 시 최대 시도횟수
        - 타임 아웃(Timeout) : 헬스 체크 실패시 최대 대기 시간, 초과시 서버 다운
        - 서비스 다운 시의 주기(Dead Interval) : 다운된 서버의 헬스 체크 주기


