## 부하 분산이란
- 서비스의 가용성을 높이기 위해 하나의 서비스는 보통 두 대 이상의 서버로 구성
    - 각 서버 IP주소가 달라서 서비스 요청시 어떤 IP를 요청할지 결정해야 한다
    - L4, L7스위치인 로드 밸런서가 사용자별로 다수의 서버에 서비스 요청을 분산시켜 부하를 분산한다
        - 사용자는 로드 밸런서의 가상IP를 통해서 서버에 접근한다

- FWLB(FireWall Load Balancing, 방화벽 부하 분산)
    - SLB(Server Load Balancing, 서버 부하 분산)
    - 방화벽 액티브-액티브 구성을 위해 로드밸런서를 사용하기도 한다
    - 방화벽 장비를 이중화 할 경우
        - 세션 테이블에 패킷 정보가 없으면 패킷을 폐기한다
            - 이중화로 경로가 두개 이상 생겨 비대칭 경로가 생기면 이런 문제가 생긴다

        - FWLB가 세션을 인식하고 일정한 규칙으로 방화벽 세션을 분산한다
            - 하나의 세션이 하나의 방화벽만 거치도록 분산
        
        - 방화벽끼리 세션테이블을 동기화하거나 첫번째 패킷이 SYN이 아니어도 허용하는 기능등으로 장애를 해결할 수도 있다

## 분하 분산 방법
- 로드밸런서는 VIP(Virual IP)를 통해서 서비스를 제공한다
    - 서비스 IP 주소 라고도 한다

- RIP(Real IP)를 가진 각 서버는 로드 밸런서의 VIP에 바인딩된다
    - 로드밸런서에서 IP와 4계층 정보인 서비스포트를 지정해서 부하분산 그룹을 만들고 요청에 적절한 서버로 트래픽을 분산시킨다
    - 로드밸런서는 서비스 포트를 변경해서 서버와 연결시킬 수도 있다
        - VIP의 80포트로 온 요청을 RIP의 8080포트로 연결시킬수 있다
    
- 동일한 RIP에서 서비스 포트마다 VIP를 다르게 설정할 수 있고 RIP의 서비스 포트와 VIP포트도 다르게 설정할 수 있다

## 헬스 체크
- 로드밸런서는 주기적인 헬스 체크를 통해 정상적인 서비스쪽으로만 부하를 분산한다
- 헬스 체크 방식
    - ICMP
        - VIP에 연결된 서버에 대해 ICMP(ping)로 서버가 살아있는지 여부만 체크, 잘 사용되지 않는다
    
    - TCP 서비스 포트
        - 로드밸런서에서 서버에 등록한 포트로 SYN을 보내고 서버가 정상적으로 응답(SYN, ACK)하면 헬스체크를 종료(ACK,FIN)보내고 응답(ACK,FIN)을 받고 끝낸다(ACK)
    
    - TCP 서비스 포트 : Half Open
        - 정상적인 3방향 핸드셰이크보다 빠른 종료로 부하를 줄이기위해 TCP Half Open를 사용하기도 한다
        - (SYN)->(SYN,ACK)->(RST)
    
    - HTTP 상태 코드
        - 서비스 포트까지는 TCP로 정상적으로 열리지만 웹 서비스에 대한 응답에 실패할 수 있다
        - HTTP를 요청해 정상적인 상태코드(200 OK)를 응답하는지 헬스 체크를 수행할 수 있다
        
    - 콘텐츠 확인(문자열 확인)
        - 로드밸런서에서 서버로 콘텐츠를 요청, 지정된 콘텐츠를 응답했는지 확인해서 헬스 체크를 한다
            - 특정 웹페이지를 호출해 지정한 문자열이 있는지 체크하는 기능

        - 서버의 상태뿐 아니라 서버의 백엔드의 상태까지 헬스 체크를 할수 있다
        
- 헬스 체크 주기와 타이머
    - 주요 타이머 값
        - 주기(Interval) : 로드밸런서에서 서버로 헬스 체크 패킷을 보내는 주기
            - 응답시간보다 크게 설정해야 한다
        - 응답시간(Response) : 패킷을 보내고 응답을 기다리는 시간, 초과시 실패
        - 시도 회수(Retries) : 헬스 체크 실패 시 최대 시도횟수
        - 타임 아웃(Timeout) : 헬스 체크 실패시 최대 대기 시간, 초과시 서버 다운
        - 서비스 다운 시의 주기(Dead Interval) : 다운된 서버의 헬스 체크 주기

# 부하 분산 알고리즘
- 라운드 로빈(Round Robin)
    - 특별한 규칙없이 순차적으로 트래픽을 분산한다
    - 총 누적 세션의 수는 같아지지만 활성화 된 세션의 수는 달라질 수 있다
    - 가중치 기반 라운드 로빈(Weighted Round Robin)
        - 라운드 로빈방식을 기반으로 각 서버에 가중치를 정의, 가중치가 높은 장비에 더 많은 부하를 분산한다

- 최소 접속 방식(Least Connection)
    - 서버가 가진 세션부하를 확인, 부하에 따라 적절하게 트래픽을 분산한다
        - 로드밸런서는 세션 테이블을 생성하기 때문에 서버에 연결된 세션의 수를 알 수 있다

    - 활성화 세션 수가 비슷하게 분산되면서 부하를 분산하게 된다
        
    - 가중치 기반 최소 접속 방식(Weighted Least Connection)
        - 최소 접속 방식을 기반으로 각 장비에 가중치를 정의, 가중치가 높은 장비에 더 많은 부하를 분산
    
- 해시
    - 부하를 고려하지 않고 클라이언트가 같은 서버에 지속적으로 접속하게 해주는 부하 분산 방식
        - 해시 알고리즘을 이용해 얻은 결과 값으로 트래픽을 결정한다 
        - 출발지, 목적지의 IP나 서비스포트가 알고리즘 계산에 사용된다
    
    - 각 서버에서 지속적으로 세션을 유지해야하는 서비스에 필요하다
        - 최소 접속이나 라운드 로빈 방식에서도 스티키(Sticky)옵션으로 세션을 유지할 수 있지만 세션 테이블에 타임아웃 이후에는 달라질 수 있다

# 로드 밸런서 구성 방식
- 원암(One-Arm) 구성
    - 로드 밸런서가 인라인이 아닌 스위치 옆에 있는 형태
        - 두개 이상의 인터페이스로 구성된 경우에도 원암 구성이 될 수 있다(LACP, VLAN)
    
    - 서버로 들어가는 트래픽이 로드 밸런서를 통과 하거나 하지 않을 수 있다
        - 부하 분산을 사용하는 서비스IP 정보를 로드 밸런서가 가지고 있어서 부하 분산을 이용하는 트래픽은 로드밸런서를 거친다
        - 원암 구조이기 때문에 응답 트래픽이 로드 밸런서를 다시 거치려면 목적지IP뿐만이 아니라 로드밸런서의 IP에 대한 정보도 있어야 한다
    
    - 불필요한 트래픽이 로드 밸런서로 유입되지 않아 부하를 줄일 수 있다

- 인라인 구성
    - 로드 밸런서가 서버로 가는 인라인 경로에 있는 형태
    - 서버로 향하는 모든 트래픽이 로드 밸런서를 통과 한다
        - 로드 밸런서는 L3역할을 하는 스위치에 비패 많은 데이터를 처리해서 부하에 따른 성능을 반드시 고려해야 한다
    
- 물리적 원암, 논리적 인라인
    - 물리적으로 원암 구조이더라도 VRF나 VLAN으로 논리적인 인라인으로 구성할 수 있다

## 로드 밸런서 동작 모드
- TP(Transparent) 또는 Bridge 모드
    - 로드 밸런서가 OSI 2계층 스위치처럼 동작, 서비스 IP와 실제 서버가 동일한 네트워크를 사용하는 구성이다
        - 로드 밸런서 도입을 위해 네트워크 재설계하지 않고 간단하게 구성할 수 있다 
        - 원암과 인라인 모두 트랜스패런트 구성이 가능하다
    
    - 부하 분산이 필요없는 트래픽에는 기존 L2스위치와 동일하게 작동한다
    - 부하 분산이 필요한 트래픽은 목적지 IP, MAC을 같은 네트워크의 서버로 변경해서 보낸다
        - 응답시에는 출발지 IP만 VIP로 변경해서 보낸다
    
    - 동일 네트워크에서 서비스를 요청할때 로드 밸런서를 거치지 않을 수 있다
        
- Routed 모드
    - 로드 밸런서가 라우팅 역할을 수행, 로드 밸런서를 기준으로 사용자 방향, 서버 방향이 서로 다른 네트워크로 분리된 구성이다
        - 원암, 인라인 모두 구성할 수 있다
        - 보안 강화 목적으로 서버 네트워크를 사설로 구성해서 직접 접속을 막는 용도로 사용되기도 한다

    - 요청 패킷의 출발지 MAC을 로드 밸런서로 변경, 목적지 IP, MAC을 서버로 변경한다
        - 응답 패킷의 출발지 IP, MAC를 서비스IP,MAC으로 변경, 목적지 MAC도 로드 밸런서에서 클라이언트로 변경된다
    




    
    



