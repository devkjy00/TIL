## NAT/PAT
- NAT(Network Address Translation, 네트워크 주소 변환)
    - 1:1로 IP주소를 변환한다
        - 사설IP를 공인IP로 또는 반대로 전환(가장일반적)
        - 사설IP를 다른 사설IP로 공인IP도 동일하게 전환 할수 있다
    - PAT(Port Address Translation)
        - 여러개의 IP를 하나의 IP로 변환
    - AFT(Address Family Translation) 
        - IPv4주소를 IPv6주소로 또는 반대로 변환
    
- NAT/PAT의 용도와 필요성
    1. IPv4 주소 고갈문제의 솔루션으로 NAT가 사용된다
        - NAT을 통한 공인IP와 사설IP의 사용

    2. 보안을 강화하는 데 NAT 기술을 사용한다
        - 내부 IP를 다른 IP(사설)로 변환해 통신하면 외부에 사내IP주소 체계를 숨길 수 있다
    
    3. IP주소 체계가 같은 두 개의 네트워크 간 통신을 가능하게 해준다
        - 두개의 로컬 네트워크를 합칠 때 사설IP가 충돌할 수 있다 
        - 더블 넷(Double NAT)기술로 출발지와 도착지를 한꺼번에 변환할 수 있다
    
    4. 불필요한 설정 변경을 줄일 수 있다
        - NAP/PAT를 이용해 내부 네트워크를 구성하면 서버와 PC의 IP주소 변경없이 회선과 IDC 사업자 이전이 가능하다
    
    - 단점
        - NAT로 인해 주소가 변환되면서 단말 간 직접적인 연결성이 무너졌고 개발자들이 개발과정에서 NAT환경을 항상 고려해야하는 상황이 되었다
    
- NAT 동작 방식
    - 로컬 네트워크에서 웹 서버에 요청하기 위해서 출발지인 사설IP를 공인IP로 변경한다
        - 변경 전후의 IP주소는 NAT테이블에 저장된다
    
    - 요청을 받은 웹 서버는 응답을 보내고 도착지인 공인IP는 NAT장비에서 사설IP로 다시 변경된다

- PAT 동작 방식
    - 출발지 IP뿐 아니라 서비스 포트도 변경된다
        - 서비스 포트는 IP마다 다르게 적용되서 사용자를 구분할 수 있다
        - 서비스 포트의 개수는 제한이 있어 모두 사용중이면 정상적으로 동작하지 않는다
    
    - 웹 서버가 응답을 보내면 다시 원래 IP와 포트로 변경해서 전달한다
        - PAT IP가 목적지 일때는 해당 IP가 어느 IP에 바인딩 되있는지 확인할 수 없어서 외부에서는 통신을 요청할 수 없다
    
- SNAT와 DNAT
    - SNAT(Source NAT) : 출발지 주소를 변경하는 NAT
        - 사설에서 공인으로 통신 할 때 많이 사용된다
        - 공유기처럼 PAT를 사용하는 경우이다

    - DNAT(Desination NAT) : 도착지 주소를 변경하는 NAT
        - 로드 밸런서에서 많이 사용된다
        - 사용자가 VIP(Virtual IP)로 서비스를 요청, 로드 밸런서는 VIP를 로드 밸런싱될 서버의 실제 IP로 DNAT해서 내보낸다


- 동적 NAT와 정적 NAT
    - 정적 NAT : 출발지와 목적지의 IP를 미리매핑해 고정해놓은 NAT
        - 1:1
        - NAT테이블 사전 생성

    - 동적 NAT : 출발지나 목적지가 사전에 정해지지 않고 동적으로 변경하는 것 
        - 출발지나 목적지중 한곳이 다수의 IP로 구성된 IP pool이나 Range로 설정되어 있다
        - 1:N, N:1, N:M
        - NAT수행시 NAT테이블 생성

## DNS(Domain Name System )
- 네트워크 프로토콜
    - 데이터 프로토콜
        - 데이터 전달
    - 컨트롤 프로토콜
        - 통신을 제어(ARP, ICMP, DNS)

- DNS 
    - 도메인 주소를 IP주소로 변환하는 역할
        - 사용자에게 익숙하고 서버IP변경이 쉽다
    
    
    - 동작
        1. 도메인 주소로 서비스 요청
        2. DNS 서버로 해당 도메인에 대한 IP주소 질의
        3. 서비스의 IP주소를 받아서 통신


- 구조와 명명 규칙
    - 도메인은 계층구조로 주소를 효율적으로 탐색할 수 있다
        - '.'로 계층을 구분한다
        - 역트리 구조로 Third-Level.Second_Level.Top-Level로 주소를 찾는다
            - www.naver.com
            - com -> naver -> www 순서로 해석 

        - TLD(Top-Level Domain)
            - 최상위 도메인으로 IANA에서 구분한 6가지 유형으로 구분할 수 있다
                - Generic(gTLD)
                    - 특별한 제한 없이 일반적으로 사용되고 세글자 이상으로 구성된다
                    - com(일반기업), edu(4년제 이상 교육기관), gov(미국 연방정부기관), int(국제기구, 기관), net(네트워크 관련기관), org(비영리기관)

                - country-code(ccTLD)
                    - 국가 최상위 도메인, ISO 3166표준에 규정된 두 글자의 국가 코드를 사용(kr)
                    - ccTLD를 사용할 경우 Second-Level에 gTLD를 사용한다(co.kr)
                        - 우리나라는 gTLD를 두글자로 줄여서 사용한다

                - sponsored(sTLD)
                    - 특정 목적을 위한 스폰서를 두고 있는 최상위 도메인
                        - 스폰서(민족공동체, 전문가 집단, 지리적 위치등)
                    - aero, asia, edu, museum 등 

                - infrastructure
                    - 운용상 중요한 인프라 식별자 공간을 지원하기 위해 전용으로 사용되는 최상위 도메인
                    - arpa : 인터넷 안정성 유지를 위해 새로운 모든 인프라 하위 도메인이 배치될 도메인 공간 역할
                        - 리버스도메인에서 사용된다

                - generic-restricted(grTLD)
                    - 특정 충족하는 사람이나 단체가 사용할 수 있는 최상위 도메인
                    - biz, name, pro

                - test(tTLD)
                    - IDN(Internationallized Domain Names) 개발 프로세스에서 테스트 목적으로 사용한다
                    - test
        
    
        
    - 명명규칙
        - 최대 128계층 까지 구성 가능
        - 알파벳, 순자, "-"만 사용가능하고 대소문자 구분이 없다
    
    - 루트 도메인
        - 도메인을 구성하는 최상위 영역, 전 세계에 13개가 있다
            - DNS서버를 설치하면 루트 DNS의 IP주소를 기록한 루트 힌트 파일이 생성된다
            - 반복적 쿼리(Iterative Query)
                - DNS서버에 도메인의 정보가 없으면 루트 도메인을 관리하는 루트 DNS에 쿼리하게 된다
                - 루트 DNS는 TLD값을 확인해 담당 루트DNS가 어디인지 응답하고 서버는 해당 루트 DNS로 쿼리한다
        
- DNS 동작 방식
    - DNS서버에 쿼리하는 방법
        - 재귀적 쿼리(Recursive Query)
            - DNS 캐시를 먼저 확인하고 정보가 없으면 DNS서버에 쿼리한다
        - 동적 DNS캐시 : 응답받은 DNS의 IP주소를 캐시에 저장한다


    - 로컬에 도메인과 IP주소를 직접 설정하는 방법
        - hosts 파일 : 로컬에서 도메인과 IP를 관리하는 파일
            - 윈도우 hosts 파일 : C:\Windows\System32\drivers\etc\hosts
            - 리눅스 hosts 파일 : /etc/hosts

        - 정적 DNS캐시 : hosts 파일의 도메인 리스트는 항상 DNS캐시에 저장된다
            - hosts 파일을 임의로 변경하고 원래 사이트와 동일한 디자인 구성 사이트를 만들어서 사용자의 정보를 빼내려고 할 수 있다
    
- 마스터와 슬레이브
    - DNS서버는 마스터(Primary)서버와 슬레이브(Secondary)서버로 나눌 수 있다
        - 마스터 서버
            - Zone 파일을 직접 생성, 관리
            - 미리 설정된 서버만 영역 전송이 가능하도록 제한할 수 있다

        - 슬레이브 서버
            - 영역 전송(Zone Transfer) : 마스터에 만들어진 Zone파일을 정기적으로 복제
    
    - 마스터 서버에 장애가 발생하면 만료시간(Expiry Time)후 슬레이브 서버도 동작하지 않는다
        - 만료시간 안에 마스터 서버를 복구하거나 슬레이브 서버를 마스터로 전환해야만 서비스 장애를 막을수 있다
    
    - *마스터와 슬레이브는 도메인별로 설정할 수 있지만 모든 도메인에 대해 동일하게 설정하는 것이 바람직한 방법이다*

- *액티브-스탠바이, 액티브-액티브*
    - 액티브-스탠바이 : 한쪽만 서비스를 제공, 한쪽은 대기
    - 액티브-액티브 : 양쪽모두 서비스를 제공
    - 한쪽에 장애가 발생해도 서비스가 지속되도록 고가용성(High Availability)기술을 제공한다

- DNS 주요 레코드
    - 종류
        - A(IPv4 호스트) : 도메인 주소를 IPv4로 매핑
            - 기본 레코드로 도메인 주소를 IP주소로 변환하는 레코드
            - IP와 도메인을 1:1로 매핑
            - 하나의 IP를 여러번 다른 도메인과 매핑하거나 반대로도 할 수 있다
                - 같은 IP라도 도메인 별로 HTTP헤더의 HOST필드에 도메인을 명시해서 웹 서버를 구분해 서비스 할 수 있다

        - AAAA(IPv6 호스트) : 도메인 주소를 IPv6로 매핑
            - 도메인 주소를 IPv6주소로 변환하는 레코드

        - CNAME(Canonical Name) : 도메인 주소에 대한 정식이름 
            - IP가 아닌 도메인 주소를 매핑한다
            - www.naver.com - naver.com
            - IP가 변경되면 CNAME은 도메인명을 매핑하기 때문에 도메인의 매핑만 변경하면 된다

        - SOA(Start Of Authority, 권한 시작) : 도메인 영역 대한 권한
            - 현재 네임서버가 해당 도메인 대한 관리 주체임을 의미
                - 다른 서버에 질의하지 않고 직접 응답한다

            - 도메인 영역 선언시 SOA레코드는 필수로 생성해야 한다
                - 만료시간, TTL, 관리자 도메인 관리에 필요한 값들을 설정

        - NS(Name Server) : 도메인에 대한 권한이 있는 네임 서버정보
            - 도메인의 권한을 가진 서버정보외에도 하위 도메인에 대한 권한을 다른 네임 서버로 위임하는 역할도 있다

        - MX(Mail eXchange) : 메일 서버를 구성할 때 사용되는 레코드
            - 도메인을 메일 주소로 같는 메일 서버를 선언
            - 우선순위가 높은 서버를 우선적으로 메일을 보낸다

        - PTR(Pointer) : IP주소를 도메인에 매핑(역방향)
            - 리버스도메인, 하나의 IP에 대한 하나의 도메인주소만 가질 수 있다
            - 화이트 도메인 구성에 사용된다

        - TXT(TeXT) :  도메인을 설명하는 일반 텍스트
            - 화이트 도메인을 위한 SPF로 사용될 수 있다
        
- DNS에서 알아둬야할 내용
    - 도메인 위임(DNS Delegation)
        - 자신의 도메인 관리 권한을 일부 위임해서 세부 레코드를 관리하도록 한다(CDN, GSLB)
            - 관리 주체를 분리하는 용도, 계열사에서 특정 도메인을 분리하거나 GSLB등 다양한 용도로 사용된다
        - 레코드를 위임하면 해당 레코드의 하위계층도 위임처리된다

    - TTL(Time To Live)
        - DNS에서 응답받은 결과값을 캐시에 유지하는 시간
            - TTL이 길면 부하가 줄고 응답이 빨라지지만 변경되면 정보갱신이 그만큼 지연된다
            - IDC이전이나 공인 IP, 서비스 변경을 할때 TTL값을 미리 극도로 줄여 정보갱신을 빠르게 할 수 있다
        
        - *도메인 관련 시간*
            - refrech(새로 고침 간격) : 보조 네임 서버에서 Zone Transfer로 정보를 받는 주기
            - retry(다시 시도 간격) : 보조 네임서버에서 주 네임서버로 접근 실패시 다시 시도하는 주기
            - expire(다음 날짜 이후 만료) : Zone Tranfer로 받아온 정보가 갱신되지 못할 경우 삭제하는 제한시간 

    - 화이트 도메인
        - 사전에 등록된 개인이나 사업자의 이메일 전송을 보장해주는 제도
            - 정상적인 대량 이메일이 RBL(Realtime Blackhole List, 블랙리스트)로 간주되어 차단되는 것을 방지
        
        - 화이트 도메인 등록을 위해서는 SPF(Sender Policy Framework)가 설정되어 있어야 한다
            - 윈도우에서 SPF등록시 길이를 초과하면 레코드 값이 모두 지워진다

    - 한글 도메인
        - 한글은 '퓨니코드'로 변경해서 도메인을 생성하면 한글 도메인을 만들 수 있다

        - 퓨니코드(Punycode)
            - IDNA 기반 하에서 다국어 도메인이 아스키로 변환된 구문
                - 유니코드 문자열을 인코딩 하는 것 

            - 퓨니코해에는 접두어 'xn--'가 붙는다
            - 퓨니코드 변환기로 변환된 값을 알 수 있다

    
- DNS 설정(Win)
    1. 새로운 도메인 영역 만들기
        - 실행창에서 "ServerManager"를 입력
        - '서버관리자' 실행
        - '서버역할' 추가
        - DNS Server역할 선택 -> DNS서버 구성 설치, 서버기능 추가
        - 실행창 "dnsmgmt.msc"입력 DNS관리자 실행
        - 정방향 조의 영역 우클릭 -> 새 영역 선택
        - 주 영역 선택
        - DNS서버를 통해 관리하려는 도메인을 기입
        - 도메인 영역 이름.dns 으로 파일이름설정
        - '동적 업데이트 허용 안 함' 선택, 마침 -> 생성 완료
            - 새로 생성된 도메인에는 SOA와 NS레코드가 자동으로 들어가 있다

    2. 새 레코드 만들기 
        - 도메인 명에서 우클릭해서 원하는 레코드 추가할 수 있다
        - A 레코드 클릭
        - 도메인명을 입력하면 FQDN이 자동 표기된다, 매핑할 IP입력 
        - 호스트 추가 -> 도메인 영역에 레코드가 추가된다

    3. 하부 도메인 계층 추가
        - 도메인 영역 우클릭 '새 도메인' 선택
        - 이름을 만들면 추가 계층으로 도메인 생성됨

- DNS 설정(Linux)
    - bind 패키지 설치
        - 초기 설정은 DNS의 53번 포트가 로컬호스트로 설정 되어 있기 때문에 로컬 서버에서만 질의가능
        - /etc/named.conf 파일의 option안에 아래 항목을 any로 수정하면 외부에서 질의가능
            - listen-on port 53, listen-on-v6 port 53, allow-query 
        - (버전 확인)$/usr/sbin/named -v
    
    - 정방향 도메인 영역 추가
        - /etc/named.rfc1912.zones 파일 생성
            ```
            zone "도메인명.kr" IN {
                type master;
                file "도메인명.kr.zone";
                allow-update { none; };
            }
            ```
            - 마스터서버로 지정
            - 도메인의 세부정보가 들어있는 Zone파일이름 지정
            - 슬레이브 서버 없음

    - Zone 파일 설정 
        - 기본 zone파일을 복사해 사용한다
            - $ cp /var/named/named.empty /var/named/도메인명.kr.zone
        - 파일 작성
            ```
            $TTL 3H
            @ IN SOA ns.도메인명.kr. root.도메인명.kr(
                0   ; serial
                1D  ; refresh
                1H  ; retry
                1W  ; expire
                3H ); minimum
                NS ns.도메인명.kr.
                A (IP매핑)
            ns  A 10.1.1.5
            ```
        - bind에서 사용하도록 파일 권한 변경
            - ls -al /var/named | grep 도메인명.kr.zone
            - chown root:named /var/named/도메인명.kr.zone
            - ls -al /var/named | grep 도메인명.kr.zone
        
        - bind 서비스 데몬 실행
            - systemctl start named.service
            - bind 서비스 데몬 실행시 Active 항목에 'active(running)'으로 표기


## GSLB(Global Server/Service Load Balancing)
- 동일한 DNS 서로 다른 IP주소를 설정하면 도메인 질의에 따라 IP주소를 다르게 응답해서 로드밸런싱할 수 있지만 부적절하다
    - ***DNS서버는 IP주소의 서비스가 정상인지 확인하지 못하고 무조건 IP주소를 응답한다***

- GSLB 동작방식
    1. 사용자가 DNS 질의
    2. LDNS에서 DNS를 관리하는 NS서버로 질의
        - LDNS서버에서 root부터 순차로 질의해서 NS서버를 찾는다
    
    3. DNS서버에서 NS서버를 GSLB서버로 위임했다고 응답
    4. LDNS는 다시 GSLB로 질의
    5. GSLB는 설정된 분산방식에 따라서 정상적인 IP주소를 응답
        - IP주소에 대한 헬스 체크를 통해 정상적인 서비스가 가능한지 확인 한다

    6. LDNS는 사용자에게 IP응답

- GSLB 구성 방식
    - GSLB 도메인 설정 방법
        - 도메인 자체를 GSLB로 사용
            - 모든 레코드를 GSLB에서 관리, NS서버역할을 한다
                - GSLB에 부하를 줄 수 있다

        - 도메인 내의 특정 레코드만 GSLB를 사용
            - CNAME, NS 레코드가 사용해서 DNS는 GSLB로 질의하도록 위임한다
            - CNAME 레코드 사용
                1. 사용자가 LDNS(Local DNS)로 질의
                2. LDNS에서 root서버 질의로 NS서버를 찾아서 질의
                3. DNS서버에서 CNAME의 FQDN인 GSLB 도메인을 응답
                    - CNAME으로 하나의 FQDN을 위임처리 하위 도메인은 별도 설정없이 위임처리 된다
                    - DNS서버 설정을 최소화해서 GSLB로 다수의 FQDN을 위임 할 수 있다

                4. LDNS에서 root서버 질의로 GSLB의 NS서버를 찾아서 질의
                5. GSLB서버에서 IP를 응답하고 LDNS는 사용자에게 응답
            
            - NS 레코드 사용

                3. NS 레코드의 지정된 네임 서버인 GSLB도메인을 응답

- GSLB 분산 방식
    - 서비스 제공의 가능 여부를 체크해 트래픽 분산
        - 서비스 응답시간/지연(RTT/Latnecy)을 확인한다

    - 지리적으로 멀리 떨어진 다른 데이터 센터에 트래픽 분산
    - 가까운 서비스에 접속하도록 해서 빠른 서비스 제공
    
## DHCP
- 네트워크 정보 할당
    - 정적 할당 : 수동으로 IP와 네트워크정보를 직접 설정
        - 데이터 센터와 같은 운영망에서 사용된다

    - DHCP(Dynamic Host Configuration Protocol,동적 할당) : 서버를 이용해서 자동을 설정
        - 일반적인 PC환경에서 사용된다

- DHCP 프로토콜
    - BOOTP(Bootstrap Protocol)을 기반으로 확장된 프로토콜이다
        - 서비스 포트가 같고 서로 송, 수신이 가능하다
    
- DHCP 동작 방식(임대과정,Lease)
    1. DHCP Discover
        - 클라이언트는 DHCP서버를 찾기 위해 DHCP Discover메시지를 브로드캐스트로 전송
            - 아직 IP가 없는 상태, 패킷을 정상적으로 보낼수 없어서 UDP사용
            - 출발지는 Zero IP주소(0.0.0.0), UDP 68
            - 도착지는 브로드캐스트주소(255.255.255.255), UDP 67
             

    2. DHCP Offer
        - DHCP서버에서 IP, 서브넷, 게이트웨이, DNS, Lease Time 등의 정보를 포함한 DHCP메시지를 전송
            - DHCP IP Pool중에서 할당할 IP를 선택한다
            - 클라이언트의 MAC주소와 IP주소를 미리 정의, 고정된 IP를 할당할 수 있다
    
    3. DHCP Request
        - DHCP서버로부터 받은정보를 포함한 DHCP 요청메시지를 다시 브로드캐스트로 전송
            - Offer 메시지 여러개를 수신받고 그 중 하나에 대해 요청을 전송한다
            - IP정보를 가지고 있지만 여러 서버가 동작하는 환경을 활용하기 위해 브로드 캐스트로 전송
    
    4. DHCP Acknowledgement
        - 요청을 받으면 해당 IP를 사용설정하고 정상적으로 수신했다는 응답을 전송한다
            - 자신이 보낸 DHCP 메시지를 받은 클라이언트에 요청에만 응답한다

    5. 임대시간에 따라 IP를 갱신(Renewal)하거나 재할당해야 한다
        - 갱신
            - 임대 시간의 반이 지나면 수행한다
                - 갱신이 두번 실패하면 재할당 하게 된다
            - 앞 과정은 생략하고 유니캐스트로 Request메시지를 바로 보낸다

- DHCP 메시지 타입과 항목
    - Discover, Offer, Request
    - Decline : 제안 받은 IP가 사용중임을 서버에 알리는 메시지
    - Ack : 클라이언트의 요청을 수락하는 메시지
    - Nak : 클라이언트의 요청을 거부하는 메시지
    - Release : 서버에 IP를 반납할 때 쓰는 메시지
    - Inform : 서버에 IP 설정값을 요청하는 메시지 

- DHCP Starvation 공격
    - DHCP 서버에서 관리하는 IP Pool에 가용 IP를 가짜로 모두 할당받아 동작을 막는 방식의 공격

- DHCP 서버 구성
    - 윈도 서버의 DHCP 서비스, 리눅스의 DHCP 데몬으로 구성할 수 있다
        - 네트워크, 보안 장비에서도 DHCP서비스가 가능하다
    
    - DHCP 서버 설정 값
        - IP 주소 풀 : 할당할 IP주소 범위
        - 예외 IP 주소 풀 : 가용 IP주소중 할당하지 않을 범위
        - 임대 시간, 서브넷 마스크, 게이트 웨이, DNS
    
    - 윈도우의 DHCP 서버 구성
        - ServerManager...
    
    - 리눅스 DHCP 서버 구성
        - dhcp 패키지 ...
    
- DHCP 릴레이
    - DHCP서버와의 통신은 브로드캐스트로 서버가 로컬 네트워크에 있어야만 통신이 가능하다
        - 릴레이 에이전트는 여러 네트워크의 IP풀을 관리할 수 있다
        - 브로드캐스트를 DHCP서버로 바로 가도록 유니캐스트로 변환한다
    
    - 동작 
        - 클라이언트는 기본 동작 방식과 똑같다
        1. Discover(클라이언트 -> 릴레이 에이전트 -> DHCP 서버)
            - 출발지는 릴레이 에이전트, 목적지는 DHCP로 변경, 유니캐스트 통신
            - 목적지는 DHCP서버 로컬 네트워크의 IP, 메시지의 릴레이 에이전트 IP는 클라이언트 로컬 네트워크의 IP를 사용한다
        
        2. Offer(DHCP 서버 -> 릴레이 에이전트 -> 클라이언트)
            - DHCP 메시지를 릴레이로 전달(유니캐스트)
            - 릴레이에서 메시지를 브로드캐스트 전송한다
                - DHCP Server Identifier값만 DHCP서버 IP에서 릴레이 IP주소로 변경되어 전송한다

        3. Request(클라이언트 -> 릴레이 에이전트 -> DHCP 서버)
        
        4. ACK(DHCP 서버 -> 릴레이 에이전트 -> 클라이언트)