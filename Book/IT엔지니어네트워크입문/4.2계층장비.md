## 스위치 장비 동작
- 스위치 : 네트워크에서 통신을 중재하는 장비
    - 각 단말의 위치를 MAC주소 테이블에 저장하고 패킷을 정확히 전송한다
        - MAC주소가 어느포트에 있는지 확인한다
        - MAC주소가 포트에 없으면 전체 포트로 전송한다

    - 패킷의 경합으로 네트워크 성능 저하가 발생하는 것을 막아준다

- 플러딩(Flooding) : 스위치가 허브처럼 모든 포트로 패킷을 보내는 동장
    - 스위치를 부팅하면 네트워크 관련 정보가 없어서 플러딩을 통해서 MAC주소를 학습한다

    - 비정상적인 플러딩
        - 이더넷-TCP/IP 네트워크에서는 ARP브로드캐스트를 사용하기 때문에 실제 데이터를 보낼때는 플러딩을 하지 않는다
        - 이런 스위치 기능을 무력화해서 통신을 모니터링하는 공격 기법이 사용된다
            - 스위치에 엉뚱한 MAC주소를 습득시키거나 MAC테이블을 꽉 차게 해서 스위치의 플러딩 동작을 유도할 수 있다
            - 아무이유없이 플러딩이 된다면 고장이거나 공격이 수행되는 상황이다
        
        - ARP 포이즈닝(Poisoning)기법
            - 모니터링 해야할 IP의 MAC주소가 공격자 자신인 것처럼 속여서 원하는 통신을 받는 방법
        
- 어드레스 러닝(Address Learning) : MAC주소 테이블을 만들고 유지하는 과정
    - 패킷의 출발지 MAC주소 정보를 이용해서 테이블에 주소와 해당 포트번호를 저장한다
    - 출발지 MAC주소 정보만 사용하기 때문에 목적지 MAC주소에 사용되는 브로드캐스트, 멀티캐스트에 대한 주소정보는 학습할 수 없다
    
    - 사전 정의된 MAC주소 테이블 
        - 보통 스위치 간 통신을 위해 사용되는 주소이다
        - 스위치에서 자체 처리되는 주소는 특정 포트로 내보내는지 않아서 인접 포트 정보가 없거나 CPU 혹은 관리 모듈을 지징하는 용어로 표기된다
    
- 포워딩/필터링(Forwarding/Filtering)
    - 필터링 : MAC테이블과 도착지 주소를 비교해서 해당 포트로 패킷을 포워딩하는 동작
        - 포워딩과 필터링작업은 여러 포트에서 동시에 독립적으로 실행될 수 있다

    - 스위치는 일반적인 유니캐스트만 포워딩과 필터링 작업을 수행하고 BUM트래픽에는 다르게 동작한다
        - 브로드캐스트와 멀티캐스트는 출발지 MAC이 사용되지 않기때문에 플러딩한다
        - 언노운 유니캐스트도 MAC주소 테이블에 없기 때문에 플러딩한다
    
    - LAN에서의 ARP - 스위치 동작
        - 이더넷-TCP/IP 네트워크에서는 ARP 브로드캐스트로 양 쪽의 MAC주소가 스위치에 저장되기 때문에 유니캐스트가 시작되면 패킷을 바로 포워딩, 필터링한다
        - 에이징 타임(Aging Time) : ARP와 MAC테이블은 지워지지 않는 일정 시간
            - 일반적으로 MAC테이블의 에이징타임이 ARP보다 길다
    

## VLAN(Virtual Local Area Network)
- VLAN : 물리적 배치와 상관없이 LAN을 논리적으로 분할, 구성하는 기술
    - 과도한 브로드캐스트로 인한 단말들의 성능저하, 보안 향상을 위한 차단 용도등의 이유로 네트워크는 분리되는게 좋다
    - VLAN으로 한 대의 스위치를 분할해서 별도의 스위치처럼 동작시킬 수 있다
        - 서로 다른 네트워크가 된 것, VLAN간 통신은 로컬이 아니기 때문에 3계층 장비가 필요하다
    
    - 물리적으로 다른 층에 있는 단말을 하나의 VLAN을 사용해 동일한 네트워크로 묶을 수도 있다
        - 로컬 네트워크 안에서는 스위치끼리 연결되어있으면 같은 VLAN으로 설정 가능하다

- VLAN의 종류와 특징
    - 포트 기반 : 스위치를 논리적으로 분할해서 사용하는 것이 목적, 일반적인 VLAN
        - 어떤 단말이 접속하든지 특정 포트에 VLAN을 할당하면 VLAN에 속한다

    - MAC 기반 : 단말의 MAC주소를 기반으로 VLAN을 할당, 다이나믹 VLAN
        - 단말이 연결되면 MAC주소를 인식해서 포트를 지정된 VLAN으로 변경한다
    
    - 데이터 센터에서는 포트 기반 VLAN을 일반적으로 사용하지만 최근 사용자의 이동성을 요구하는 경우가 많아져서 MAC기반 VLAN도 많이 사용되고 있다

- VLAN모드(Trunk/Access)의 동작 방식
    - VLAN을 통해서 스위치를 논리적으로 분리한 경우 VLAN간의 통신을 위해서는 스위치간 통신을 위한 포트가 필요하다
        - VLAN의 개수만큼 필요하고 이는 포트를 낭비하게 만든다
    
    - VLAN 태그 : 하나의 포트에 여러VLAN의 패킷을 전송, 모든 VLAN간의 통신을 할수 있다
        - 패킷헤더에 VLAN ID 필드값 등을 정의해서 해당 VLAN으로 패킷을 전달 한다 
        - 이 포트를 태그(Tagged) 또는 트렁크(Trunk) 포트라고 한다
            - 주로 여러 네트워크가 설정된 스위치간의 연결에 사용된다

    - 언태그(Untagged),엑세스(Access) 포트 : 일반적인 포트, 하나의 네트워크에 속한 경우
        - 같은 네트워크, VLAN에만 패킷을 전송한다

    - MAC주소 테이블에서 VLAN을 지정하는 필드가 추가되었고 다른 VLAN에 속한 포트로는 플러딩하지 않는다
        - VLAN별로 MAC주소 테이블이 따로 존재하는 것처럼 동작한다
        
## STP
- SPoF(Single Point of Failure: 단일 장애점) : 하나의 시스템이나 구성요소의 고장으로 전체 시스템이 멈추는 요소
    - 이것을 막기위해 이중화, 다중화 된 네트워크를 구성한다
        - 스위치 두 대로 네트워크를 연결할 수 있다
        - 루프가 발생할 수 있다
    
- 루프(Loop) : 다중화 된 네트워크에서 연결이 순환되는 것, 네트워크가 마비되고 될 수있다
    - 브로드캐스트 스톰 
        - 루프 네트워크에서 브로드캐스트를 발생, 스위치가 플러딩을 하고 패킷을 받은 다른 스위치도 다시 플러딩을 하면서 반복된다
            1. 네트워크에 접속된 단말의 속도가 느려진다(브로드캐스트 처리로 CPU사용률이 높아진다)
            2. 네트워크 접속 속도가 느려진다(통신 불가 수준) 
            3. 스위치에 모든 LED들이 동시에 빠르게 깜빡인다
        
        - TTL(Time to Live) : 패킷 수명, 3계층 헤더값
            - 2계층 헤더에는 이런 라이프타임 메커니즘이 없어서 루프를 막을 수 없다
        
    - 스위치 MAC러닝 중복 문제(MAC Address Flapping)
        - 루프구조로 인해 같은 패킷이 다른 포트로 중복 전달된다
            - MAC주소 테이블에서는 하나의 MAC주소에 대해 하나의 포트만 학습할 수 있다
            - MAC주소가 반복 갱신되서 제대로 전달하지 못하고 패킷을 플러딩한다

- STP(Spanning Tree Protocol)
    - BPDU프로토콜으로 루프를 확인하고 적절히 포트를 차단해서 루프를 예방하는 매커니즘
        - BPDU(Bridge Protocol Data Unit) 프로토콜 : 스위치 간에 정보전달로 수집된 정보로 전체 네트워크 트리를 만들어 루프 구간을 확인한다
            - 스위치의 고유값을 헤더에 Bridge ID정보로 추가 한다 
    
    - 스위치 포트의 상태 및 변경 과정
        - 스패닝 트리 프로토콜이 동작 중인 스위치에 신규 스위치가 연결되면 바로 트래픽을 차단하고 BPDU로 구조를 파악한다
        - 신규 스위치 포트의 4가지 상태
            - Blocking 
                - 패킷 데이터 차단, BPDU를 기다린다
                - Max Age까지 응답을 기다린다
                - 기본 교환 주기는 2초, 10번 기다린다 
            
            - Listening 
                - 포트가 전송 상태가 되도록 준비하는 단계 
                - 자신의 BPDU정보를 전송한다
                - 15초 대기
            
            - Learning
                - 패킷을 포워딩 할 때 MAC주소를 학습한다
                - 15초 대기
            
            - Forwarding
                - 패킷을 포워딩하는 정상적인 통신
            
            - 50여 초정도 소요 된다, 스위치가 아닌 단말을 연결해도 동일한 시간이 소요된다
                - 부팅이 빠른 OS가 DHCP 네트워크에 접속할 떄 스위치 포트가 포워딩 상태가 되지 않아 IP를 정상적으로 할당 받지 못하는 경우가 많다
    
    - STP 동작 방식
        - 루프를 없애기 위해 토폴로지를 구성한다
        - STP 동작
            - (루트 포트) -> BPDU -> (지정 포트)
            1. 루트 스위치 선정
                - 루트 스위치(브릿지) : 뿌리가 되는 스위치, 이 스위치를 통해서 모든 BPDU가 교환 되도록 한다
                    - 모든 스위치는 처음에 자신을 루트 스위치로 인식하고 동작한다
                    - BPDU의 브릿지 ID값을 비교, 값이 적은 스위치를 루트 스위치로 선정한다

            2. 루트가 아닌 스위치는 모두 하나의 루트 포트를 선정
                - 루트 포트 : 루트 브릿지로 가는 경로가 가장 짧은 포트
            
            3. 하나의 세그먼트에 하나의 지정(Designated)포트 선정
                - 지정 포트 : 스위치와 스위치를 연결하는 2포트중 하나로 선정, BPDU송신
                    - 한쪽이 루트포트이면 반대쪽이 지정포트

                - 대체 포트 (Alternate, Non-designated) : 지정포트 반대쪽, BPDU를 수신, Block되는 포트이다 
            
        - STP 사용시 대안(Port Fast)
            - 포트를 Port Fast로 설정하면 BPDU대기, 습득 과정없이 바로 포워딩 된다
                - 통신까지 시간이 지연되는 문제해결
                - 루프예방을 위해 BPDU Guard기술과 함께 써야한다
    
    - 향상된 STP(RSTP, MST)
        - STP 문제점
            - TCP기반 애플리케이션은 네트워크가 차단되고 30초가 지연되면 연결이 끈어진다
                - STP 기반 네트워크에 장애가 생기면 통신이 끊길 수 있다

            - VLAN별로 STP를 계산하면서 부하가 발생하기도 한다
            - 토폴로지 변경 시 스위치가 정보를 루트스위치까지 보냈다가 다시 루트스위치에서 모든 스위치로 전파해야해서 시간이 지연된다
            - 

        - RSTP(Rapid Spanning Tree Protocol)
            - 개선점
                - BPDU 메시지 형식이 다양해져 여러 가지 플래그를 교환할 수 있다
                - 토폴로지 변경시 스위치 자신이 모든 네트워크에 변경을 직접 전파한다 
            
            - 동작이 빨라졌다, 2~3초 내로 장애 복구가 가능하다        
                - 포트가 차단되도 통신이 끊지지 않는다
            
        - MST(Multiple Spanning Tree)
            - PVST(Per Vlan Spanning Tree)
                - VLAN마다 다른 STP를 동작시켜서 각각 별도의 경로와 트리를 만든다
                    - VLAN마다 최적의 경로, 블록 포트를 구성해서 네트워크 로드를 셰어링할 수 있다
                
                - 이런 구성을 스위치에 많은 부하를 건다
                    - 보완하기 위해 MST가 개발되었다
                
            - 여러VLAN을 하나의 리전으로 묶고 별도의 스패닝 트리를 동작시킨다
                - 더 적은 부하로 로드 셰어링기능을 사용할 수 있다
            
        
- 스위치 구조와 스위치에 IP주소가 할당된 이유
    - 스위치의 2가지 분류
        - 컨트롤 플레인(Control Plane) : 스위치 관리
            - STP, 스위치 원격관리용 텔넷, SSH, 웹 등의 서비스수행

        - 데이터 플레인(Data Plane) : 패킷 포워딩

    - 스위치는 2계층장비 이지만 규모가 있는 네트워크에서 운영되는 스위치는 관리 목적으로 IP주소가 할당된다

