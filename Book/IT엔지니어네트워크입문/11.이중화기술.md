- 안정적 서비스를 위해서는 네트워크뿐 아니라 애플리케이션도 이중화 기술을 적용해야 한다

## 이중화 기술 개요
- SPoF(Single Point of Failure) 
    - 시스템 구성 요소 하나가 동작하지 않으면 전체 시스템이 중단되는 요소
    - SPoF를 최소화해서 전체 서비스를 안정적으로 설계해야 한다

- 이중화의 목적
    - 인프라를 구성하는 각 요소가 복수여야 장애 발생시 다른 인프라를 통해 서비스가 지속된다
    - 서비스가 필요한 출발 지점부터 끝 지점까지(End-to-End) 모든 인프라에 이중화 구성을 고려해야 한다
        - 액티브-액티브또는 액티브-스탠바이 형태로 구성한다
        - 액티브-액티브 구성으로 요청을 동시 처리하면 처리가능한 전체 용량이 증가한다
            - 이 용량을 기준으로 하면 한쪽에 장애가 발생했을때 처리가능한 양이 반으로 줄어서 정상적인 서비스가 불가능하다

    - 이중화의 목적
        - 장애 허용(FT, Falut Tolerance) : 이중화는 장애 상황에도 서비스에 연속성이 보장한다

- *데이터 센터의 이중화*
    - DR센터(Disaster Recovery Center, 재해복구센터) 
        - 데이터 센터에 장애 발생시 서비스를 대신 처리한다


## LACP
- 1990년대 중반, 벤더별로 장비 간 대역폭을 늘리기 위해 독자적인 방법을 구현했지만 다른 장비와 호환성 문제 발생
- LACP(Link Aggregation Control Protocol) : IEEE 802.3 그룹에서 시작한 상호호환 가능한 연결 계층 표준화
    - 현재 IEEE 802.1AX-2008에 명시되어있다
    - 두개 이상의 물리인터페이스로 구성된 논리 인터페이스로 액티브-액티브... 구성을 사용해서 대역폭을 확장한다
    - 목적
        - 대역폭 확장을 통한 
            - 링크 사용률 향상(Improved Utilization of Available Link)
            - 향상된 장애 회복(Improved Resilience)

    - 유의사항
        1. 전체 트래픽 기준을 물리 인터페이스 하나의 대역폭으로 정해야 장애 발생시에 정상적인 서비스를 제공할 수 있다
        2. 구성 물리 인터페이스들의 속도가 동일해야 한다
        
- LACP 동작 방식
    - LACPDU(LACP Data Unit) : LACP를 통해 장비 간 논리 인터페이스를 구성하는 프레임
        - 출발지 주소, 목적지 주소, 타입, 서브 타입, 버전 정보등을 매초마다 주고 받는다
        - 멀티캐스트 통신, 목적지 주소로 "01:80:c2:00:00:02"부터 "01:80:c2:00:00:10"까지 사용
    
    - 물리 인터페이스가 같은 장비에 다중연결 되어서 단일 장비에서만 LACPDU를 주고받아야 LACP연결이 가능하다
        - (스위치)=(물리 인터페이스x2)=(스위치)
        - MAC주소가 1:1이어야 한다
        - 두개의 MAC주소 중 하나를 Primary MAC주소로 사용한다
    
    - LACP 설정
        - 양 쪽 장비모두 LACP설정을 해야만 LACPDU를 정상적으로 주고 받을 수 있다
        - 액티브 : LACPDU를 송신, 상대방이 LACP로 구성되어있으면 LACP구성(일반적)
        - 패시브 : LACPDU를 수신하면 응답해 LACP구성

- PXE(Pre-boot eXecution Environment)
    - 운영체제가 아닌 서버에서 사용하는 LACP 환경
    - 동작방식
        - (스위치)=(인터페이스x2)=(서버)
        1. 스위치에서 LACPDU를 송신
        2. OS가 없는 서버는 LACP가 구성되어 있지 않아서 LACPDU를 송신 하지 못한다
        3. 스위치에서는 LACPDU를 송신하고나서 응답을 받지 못하면 인터페이스를 하나만 활성화해서 PXE Boot를 실행한다
        4. 서버는 PXE로 운영체제를 설치하고 LACP를 설정한다
        5. LACPDU를 전달하고 스위치와 서버는 LACP로 구성된다
    
    - 벤더별 기술 명칭
        - Cisco : lacp suspend-individual
        - Arista : lacp fallback
        - Extreme : lacp fallback
        - Juniper : force-up
        - HP : lacp edge-port
     
## 서버 네트워크 이중화 설정(Windows, Linux)
- 운영체제별 이중화 관련 기술
    - 윈도우 -> teaming : team 논리 인터페이스 생성
        - 동작 모드 : Switch Independent, LACP, Static Teaming
    - 리눅스 -> bonding : bond 논리 인터페이스 생성
        - 동작 모드 : 0:라운드 로빈, 1:액티브-스탠바이, 2:balance-xor, 3:브로드캐스트, 4:LACP

- 네트워크 장비, 서버의 이중화 구성
    - 네트워크 장비 : 물리 인터페이스를 하나의 논리 인터페이스로 구성하면 액티브-액티브 상태가 된다
    - 서버 : 하나의 논리 인터페이스를 생성해도 독립적으로 상태를 설정한다
        - 서버에서 액티브-스탠바이 모드를 설정하면 네트워크 장비에서는 이중화 관련 설정을 별도로 하지 않는다

- 리눅스 본딩 모드
    - 모드 1:액티브-스탠바이
    - 모드 4:LACP
        - 액티브-액티브 방식

- 윈도우 티밍 모드
    - 스위치 독립(Switch Independent)구성
        - 액티브-스탠바이 방식
    - LACP
        - 액티브-액티브 방식


- 리눅스 본드 설정 및 확인
    - CentOS...
    - Ubuntu...

- 윈도우 팀 설정 및 확인...

## MC-LAG(Multi-Chassis Link Aggregation Group)
- 물리 인터페이스를 이중화 해도 연결된 스위치에 장애가 발생하면 이중화는 의미가 없다
    - 이런 SPoF구성을 피하기 위해 서로 다른 스위치로 이중화 구성을 하면 두 스위치 간 MAC주소가 달라 LACP를 사용할 수 없고 액티브-스탠바이로 구성해야 한다
    - MC-LAG기술로 서로 다른 스위치 간의 실제 MAC주소 대신 가상 MAC주소를 만들어 논리 인터페이스로 LACP를 구성할 수 있다

- 구성 요소
    - 피어(Peer) 장비 : MC-LAG를 구성하는 네트워크 장비
    - MC-LAG 도메인(Domain) : 두 피어장비를 하나의 논리 장비로 구성하기 위한 영역 ID, 상대방 장비가 피어장비인지 판단하는데 사용
    - 피어 링크(Peer-Link) : 두 피어장비 간의 데이터트래픽을 전송하는 인터링크
        - 벤더에 따라 MC-LAG를 구성하기 위한 제어용 패킷을 전송하는 인터페이스를 별도로 구성하기도 한다
    
    - 이 용어들은 표준 용어가 아니며 벤더별로 사용되는 용어가 다르다

- 동작 방식
    - MC-LAG를 구성하는 각 피어장비는 동일한 도메인 ID값을 갖는다
    - 패킷 전송 방법 분류
        - 피어 장비 간 데이터 트래픽을 전송하기 위한 피어링크를 구성한다, 보통 트렁크(Trunk)로 구성
            - 각 피어의 VLAN 인터페이스의 IP를 설정, 이용해서 통신

        - 제어 패킷을 위한 인터페이스(경로)를 따로 구성
            - 해당 인터페이스를 L3인터페이스로 구성해 이 인터페이스의 IP를 이용해 통신
    
    - 제어 패킷을 주고 받으면서 하나의 도메인으로 묶이고 가상 MAC 주소를 파어 장비간에 동일하게 생성한다
    - 가상 MAC주소로 LACPDU를 전송
        
    
- 벤더별 기술 명칭
    - Arista : MLAG
    - Ciena : MC-LAG
    - ...
    
- MC-LAG을 이용한 디자인
    - 서로 다른 장비를 하나의 장비처럼 인식시킬 수있다
        - 두 개의 스위치로 액티브-액티브 구성
        - 다중 스위치 간에 적용하면 루프 구조가 사라져서 STP에 의한 차단 없이 모든 포트를 사용할 수 있다
        - 다중 스위치를 1:1 구조로 구성할 수 있다

## 게이트웨이 이중화
- 게이트웨이 이중화란
    - 외부 네트워크가 목적지인 경우 게이트웨이를 통하는 L3통신
        - 호스트에 게이트웨이 설정이 잘못 되어있거나 장애가 발생하면 외부 네트워크와 통신이 불가능하다
    
    - 게이트웨이는 IP주소 설정을 통해서 외부에 경로를 제공한다
        - 두개의 게이트웨이를 연결해도 기존 IP의 게이트웨이에 장애가 나면 외부 네트워크와 통신이 불가능하다
        - *두대의 게이트웨이가 하나의 IP, MAC주소를 갖도록 하면 된다(FHRP)*

- *프록시 ARP*
    - 호스트에 게이트웨이 설정이 잘못되어있어도 게이트웨이 장비에 프록시가 설정되어 있으면 외부통신이 가능하다
    - 보안 문제로 사용하지 않도록 권고된다
    
- FHRP(First Hop Rebundancy Protocol) : 가상IP주소를 이용한 게이트웨이 이중화 프로토콜
    - 동작
        - FHRP를 구성한 게이트웨이는 가상 IP주소와 같은 그룹ID를 갖는다
            - 그룹 ID를 이용해서 가상 MAC주소를 생성
        
        - 하단 호스트가 게이트웨이에 ARP를 요청을 하면 액티브 상태인 장비가 응답한다
        - 액티브 장비에 장애 발생시 스탠바이 장비가 대신한다
            - 하단 호스트들은 아무 설정 변경없음
        
- VRRP(Virtual Router Redundancy Protocol) : FHRP 기술에 대한 표준 프로토콜
    - 게이트웨이 이중화 기술로써 거의 모든 장비에서 지원하는 기술이다
    - 동작
        - VRID 값 : VRRP 그룹을 만들기 장비마다 동일한 값을 설정
        - 그룹을 설정하고 우선순위값(기본값:100)을 설정
        - Hello 패킷을 1초마다 전달, 우선순위 비교, 액티브가 될 마스터 장비를 선정한다
            - Hello패킷은 멀티캐스트 주소인 224.0.0.18으로 통신
            - 패킷을 3회 이상 수신하지 못하면 자신이 마스터 장비가 된다
        
        - 마스터 장비는 가상IP, MAC주소를 갖게 된다

    - 시스코 NX-OS의 VRRP 설정...

- 올 액티브 게이트웨이 이중화
    - 액티브-스탠바이에서는 스탠바이 게이트웨이에 연결된 호스트도 모두 액티브 장비를 통해서만 외부로 나갈 수 있다
        - 이중화된 게이트웨이로 MC-LAG를 구성하면 피어장비로 트래픽이 나뉘어서 가도 액티브 장비로 불필요하게 우회하게 된다
    
    - 액티브-액티브로 구성하면 트래픽을 최적화할 수 있다

- 애니캐스트 게이트웨이
    - 각 위치에 같은 주소를 가지는 게이트웨이가 여러 개 동작할 수 있게한다
        - 가장 가까운 게이트웨이가 서비스를 제공한다
        - 장애가 발생해도 허용된다

- 게이트웨이 고려사항
    - 가상화 서버 내의 서로 다른 네트워크를 가지 가상 서버 간 통신
        - 동일한 가상화 서버라도 서로 다른 네트워크를 가지고 있으면 외부의 게이트웨이를 통해야 한다
    
    - 동일한 스위치에 연결된 서로 다른 네트워크를 가진 서버 간 통신(가상화 포함)
        - 네트워크가 다르면 물리, 가상 서버 모두 외부 게이트웨이를 통해야 한다
    
    - 최근에는 네트워크 가상화가 구현된 망에서 게이트웨이 역할을 서버자체의 가상 스위치에서 수행해서 빠른 통신을 제공하는 경우도 있다