## 유니캐스트, 멀티캐스트, 브로드캐스트, 애니캐스트
- Unicast : 1-1 통신, 출발지-목적지
    - 전체 네트워크(HTTP..)
    - 대부분의 통신은 유니캐스트 방식을 사용한다

- Broadcast : 1-모든 통신, 동일 네트워크 모든 호스트
    - 서브넷(로컬 네트워크)(ARP)
    - 주로 유니캐스트로 통신하기전 상대방의 정확한 위치를 알기 위해 사용된다

- Multicast : 1-그룹(멀티캐스트 구독 호스트)통신
    - 정의된 구간(방송)
    - 사내방송, 증권 시세등 단방향으로 다수에게 동시에 같은 내용을 전달 할때 사용된다

- Anycast : 1-1 통신, 다수의 동일 그룹중 가장 가까운 호스트에 응답 
    - 전체 네트워크(6 to 4DNS)
    - 게이트웨이의 성질을 이용해서 가장 가까운 DNS 서버를 찾을 때 사용된다
    - 유니캐스트와 다르게 목적지의 후보군이 다수이고 가까운 것을 선택한다

- BUM 트래픽
    - Broadcast, Unknown Unicast, Multicast
    - 서로 다른 종류이지만 네트워크에서 동작은 비슷하다

## MAC(Media Access Control)
- 네트워크 인터페이스에 할당된 고유 식별자
    -  네트워크에 접속하는 모든 장비는 MAC주소가 있어야 서로 통신할 수 있다

- MAC 주소 체계
    - 제조업체 마다 하나 이상의 주소 풀(제조사 코드,vender code)을 갖고 자체적으로 주소를 할당한다
        - 하드웨어적으로 정해져 있기 때문에 BIA(Burned-In Address)라고 부른다

    - 48비트의 16진수 12자리로 표현된다 
        - OUI : 앞의 24 비트로 IEEE가 할당한 제조사 코드값 이다
        - UAA : 뒤의 24 비트로 제조사에서 자체적으로 할당한 값이다
            - 제조사의 실수나 의도록 MAC주소가 중복 될 수도 있다
        
    - 주소 변경
        - MAC주소는 BIA 상태로 NIC에 ROM형태로 할당되서 변경이 어렵다
        - MAC주소도 메모리에 적재되기때문에 명령어나 설정파일 변경으로 MAC주소를 변경할 수 있는 운영체제도 있다
            - win은 Driver상세정보에서, 리눅스는 GNU MacChanger등에서 변경 가능하다

- MAC 주소 동작
    - NIC가 패킷의 주소를 확인해서 자기 자신이거나 같은 그룹 주소이면 처리해야 할 주소로 인지해 상위 계층이 전달한다
        - OS나 어플리케이션에서 처리하게 되고 시스템 부하가 작용한다
    
    - 무차별 모드(Probiscuous Mode)
        - 네트워크 전체 패킷을 수집,분석해야 하는 경우 NIC는 관련없는 패킷을 폐기하면 안된다
        - 무차별 모드로 NIC를 구성하면 MAC와 상관없이 모든 패킷을 전달해 처리할 수 있게 된다

- http://bit.ly/ieee_list (MAC주소의 제조사를 찾을 수 있다)

## IP 주소
- IP 주소 체계
    - IPv4(32bit), IPv6(128bit)가 사용된다
    - 네트워크 주소(호스트들은 모은 로컬 네트워크 주소), 호스트 주소로 구성된다
        - 두 주소를 구분하는 경계가 고정되어 있지 않다
        - 호스트 주소의 가장 뒷 숫자는 브로드 캐스트 주소로 사용된다
            - 네트워크 주소+1 ~ 브로드캐스트 주소-1이 호스트 주소의 범위이다
        - 127...은 자신을 의미하는 Loopback주소로 활용된다
        

- 클래스풀(Classful)
    - 클래스 풀 : 클래스 기반의 IP주소 체계
        - 서브넷 마스크가 없어도 앞 주소로 클래스를 구분할 수 있다 

    - class : 호스트 수에 따라서 네트워크 크기를 다르게 할당한다
        - A class(1-126,1옥텟), B class(128-191,2옥텟), C class(192-223,3옥텟)로 주소 첫 옥텟범위와 네트워크주소의 범위를 갖는다
        - 주소를 절약할 수 있지만 큰 사이즈의 연속되는 주소를 할당받기 어렵다

    - 현재는  class 기반으로 네트워크를 분할 하지 않고 1비트 단위로 네트워크를 분할하는 방법을 사용한다
        - 호스트가 많아지면서 43억개의 IP주소로는 부족해졌다
        - 낭비되는 IP가 매우 많아서 대책으로 
            1. (단기)클래스리스, CIDR기반의 주소체계 사용
            2. (중기)NAT와 사설 IP주소
            3. (장기)IPv6를 사용하게 됬다

- 클래스리스(Classless)
    - class가 아닌 서브넷 마스크를 사용해서 네트워크와 호스트를 구분한다
        - 계층화의 문제로 사용되지 않던 주소들을 관리해서 할당할 수 있다
        
    - 서브넷 마스크 표현 방법
        - 255.0.0.0 , /8
        - 255.255.0.0 , /16..
    
- 서브네팅(Subnetting) :부여된 주소를 다시 잘라서 클래스풀 단위의 네트워크 보다 주소를 더 분리하는 것
    - 2진수의 1비트 단위로 네트워크를 분할 한다
        - (IP)103.9.32.146 -> (서브넷)255.255.255.192 -> (네트워크 주소)103.9.32.128
        - 146(10010010) -> 192(11000000) -> 128(10 000000)
            
    - 사용자의 서브네팅
        - 사용자는 사용할 수 있는 IP주소 범위를 파악해야 제대로 통신을 할 수 있다
        - 방법
            - AND연산, 호스트 주소 비트를 모두 1로 변경해서 브로트 캐스트 주소를 알아낸다
            - 네트워크 주소+1 ~ 브로트캐스트 주소-1이 유효한 호스트 주소이다
            - 간단한 방법
                1. 호스트 주소 비트가 가질수 있는 최대 크기(예 2**6 = 64)
                2. 최대 크기의 배수로 범위 파악(0-63/64-127/128-191/192-255)
                3. IP 주소의 호스트주소 부분이 146이면 129-190범위를 갖는다
                
    - 설계자의 입장
        - 설계시 고려사항
            - 서브넷된 하나의 네트워크에 IP를 몇개 할당할지
                - 범위를 비트로 나누기 때문에 2진수의 배수로 커진다(4,8,16...)
                - 범위에서 네트워크 주소와 브로드캐스트 주소를 빼야 한다

            - 서브넷된 네트워크가 몇개 필요한지
                - 호스트 주소 범위 다음으로 이어서 추가하면 된다
            
- 공인 IP와 사설 IP
    - 공인 IP : 유일한 IP주소, 특정 주소 인터넷에 접속
        - Bogon IP : IANA에서 예약해놓아 공인 IP로 할당하지 않는 주소
            - 사설 네트워크 주소, 루프백 주소등 특정 목적으로 Bogon IP를 설정한다

    - 사설 IP : 인터넷 연결없이 개인 네트워크를 구축
        - IP를 변환해주는 NAT장비에서 공인 IP로 변경해서 인터넷 접속이 가능하다(공유기)
            - 표준 사설 IP 대역을 사용하지 않으면 NAT을 사용해도 사설 IP와 같은 대역의 공인 IP에 접속할 수 없게 된다
                - 같은 네트워크로 인식해서 정상적인 통신이 불가능 하다 
            
            
        - 클래스별 사설 IP 네트워크 주소
            - A - 10.0.0.0/8
                - 모바일 디바이스에서 가장 많이 사용된다

            - B - 172.16.0.0/12
                - 테더링 기능에서 사용된다

            - C - 192.168.0.0/16,/24
                - 공유기에서 가장많이 사용된다
        
- 인터넷 표준
    - RFC(Request for Comments)와 그 집합
        - 비평을 기다리는 문서로 인터넷 기술에 적용될 제안, 조사, 아이디어, 표준 등을 적은 메모 형식의 문서 모음이다
        - 국제 인터넷 표준화 기구가 그 중 표준 문서를 정한다

- IP주소 발신자 확인 방법
    - 한국인터넷진흥원(whois)에서 조회 할 수 있다
    - 어떤 회선 사업자, 조직의 IP인지 알수 있다

## TCP, UDP
- 2, 3계층에서는 목적지를 찾아가기위한 프로토콜(MAC, IP)이 쓰였지만 4계층에서는 단말 안의 목적지 프로세스를 정확히 찾아서 올바른 순서로 패킷을 전달하기 위한 역할을 한다

- 4계층 프로토콜(TCP, UDP)과 서비스 포트
    -  패킷을 분할하고 조합하기 위해 TCP프로토콜에서는 시퀀스 번호와 ACK번호를 사용한다
    - 4계층의 프로토콜 지시자인 포트 번호는 출발지(본인)와 목적지(수신)를 구분해서 처리해야 한다
        - 서비스 요청후 응답시에는 출발지IP와 목적지IP가 반대가 되고 포트번호도 반대가 된다
        - IANA에 등록된 Well Known포트들은 1023번 이하의 포트번호를 사용한다
        - IANA에 등록되지 않은 동적, 사설, 임시 포트의 범위는 49152~65535이다
        
- TCP
    - 패킷에 번호(시퀀스)를 부여하고 전송됬는지에 대해 응답(ACK넘버)한다
        - 안전하게 네트워크를 사용할 수 있다
    
    - 패킷순서, 응답번호
        - 보내는 쪽에서 패킷에 번호를 부여하고 받는 쪽에서 순서를 확인후 다음 패킷의 번호를 요청(ACK번호)한다
            - ACK번호와 함께 자신의 패킷에 시퀀스번호도 전송한다

    - 윈도 사이즈와 슬라이딩 윈도
        - 왕복 지연시간(RTT, Round Trip Time) 때문에 응답을 기다리는 시간이 길어져서 패킷을 한번에 많이 보내고 응답을 하나만 받는다
            - 윈도 사이즈 : 한번에 받을 수 있는 데이터 크기
            - 슬라이딩 윈도 : 네트워크 상황에 따라 윈도 사이즈를 조절하는 것
                - 패킷을 유실하면 윈도 사이즈를 반으로 줄이고 통신이 제대로 되면 조금씩 늘린다
        

    - 3방향 핸드셰이크
        - TCP는 3번의 패킷을 주고 받는 사전 연결작업을 통해 유실없는 안전한 통신을 한다
            - 서버 LISTEN : 클라이언트의 접속을 받아 들일수 있는 상태
            - 클라이언트 SYN-SENT : 통신을 시도하기 위해 Syn패킷을 보낸 상태
            - 서버 SYN-RECEIVE : Syn패킷을 받은 상태, Syn과 Ack로 응답한다
            - 클라이언트 ESTABLISHED : 서버의 응답을 받고 서버와 클라이언트간의 연결이 완료된 상태, 응답을 보낸다

        - TCP 플래그 : 기존의 연결, 새로운 연결을 구분하기위해 헤더에 넣는 값
            - SYN : 연결 시작 시 1로 표시
            - ACK : ACK 번호가 유효할 때 1로 표시, 초기 SYN이 아닌 모든 패킷에 있다
            - FIN : 연결 종료 시 1로 표시, 정상적 양방향 종료시 사용된다
            - RST : 연결 종료 시 1로 표시, 일방적으로 연결을 끊을 때 사용된다
            - USG : 긴급 데이터 인 경우 1로 표시
            - PSH : 전송할 데이터가 없거나 응용 프로그램으로 즉시 전달할 것을 지시할 때 사용
    - 특징
        - 연결 지향
        - 오류/흐름 제어
        - 유니캐스트
        - 전이중(Full Duplex)
        - 데이터 전송


- UDP
    - UDP헤더에는 신뢰 통신을 위한 내용(시퀀스, ACK, 플래그, 윈도 사이즈)가 없다 
        - 데이터 전송을 보장하지 않는 프로토콜으로 제한된 용도로만 사용된다
            - 사전 연결 절차가 없고 첫 데이터는 리소스 확보를 위해 인터럽트를 거는 용도로 사용되고 유실된다
            - UDP도 TCP를 이용해서 사전 연결을 하는 경우가 대부분이다
        - 음성 데이터나 실시간 스트리밍과 같이 시간에 민감한 경우나 방송처럼 단방향으로 다수의 단말과 통신해 응답을 받기어려운 경우에 사용된다
    
    - 특징
        - 비연결형  
        - 오류/흐름 제어x
        - 유니캐스트, 멀티캐스트, 브로드캐스트
        - 반이중(Half Duples)
        - 실시간 트래픽 전송

## ARP(Addresss Resolution Protocol)
- ARP란
    - ARP : 상대방의 MAC주소를 알아내기 위해 사용되는 프로토콜
    - 실제로 통신은 IP주소 기반으로 일어나고 ARP 브로드캐스트를 이용해 네트워크 전체에 상대방의 MAC주소를 요청한다
        - 처음 통신에서는 상대방의 MAC주소를 모르기 때문에 패킷 캡슐화를 할 수 없다
        - MAC주소를 응답받으면 정상적으로 인캡슐레이션된다
        - MAC주소를 캐시 테이블에 저장해두고 일정시간 통신이 없으면 삭제된다
    
    - 짧은 시간에 많은 ARP요청이 들어오면 네트워크 장비에서는 큰 부하로 작용한다
        - 해커들이 공격하기 취약하다
        - 이런 공격에 대응하기 위한 네트워크 장비는 ARP를 상대적으로 오래 저장하고 요청을 필터링하거나 천천히 처리하는 방식으로 보호한다

- ARP 동작
    - ARP 패킷에서 송,수신자의 MAC,IP주소를 가장 중요하게 사용된다
    1. A서버에서 B서버의 MAC주소를 알아내기위해 ARP요청을 브로드캐스트한다
        - 2계층 MAC주소는 출발지를 자신의 주소 도착지는 브로드캐스트(FF-FF-FF-FF-FF-FF)로 채운다 
        - ARP프로토콜 필드의 전송자 MAC,IP는 자신의 주소로 대상자 IP는 10.1.1.2, MAC은 00-00-00-00-00-00채워 네트워크에 뿌린다
            - ARP프로토콜의 MAC은 다른 용어를 사용해서 2,3계층의 주소와 구분해서 표현한다
    
    2. 네트워크의 모든 단말이 ARP의 대상자IP가 자신이 맞으면 응답을 보낸다 
        - 송신자와 대상자의 위치가 바뀐다
        - 자신과 대상자의 MAC,IP를 모두 채워서 응답한다
        - 브로드캐스트가 아닌 유니캐스트 통신으로 변한다
    
    3. 응답을 받으면 자신의 ARP 캐시 테이블을 갱신한다
        - 이후에는 MAC주소 필드를 완성해 ping 패킷을 보낸다
    
- GARP(Gratuitous ARP) :다ARP의 필드의 내용을 변경해서 다른용도로 사용한다
    - GARP패킷의 대상자 IP에 자신의 IP주소 대상자 MAC에는 모두 0으로 채워서 ARP요청을 보낸다
    - 2계층 목적지 MAC주소에 브로드캐스트 MAC주소를 사용한다

    - ***로컬 네트워크에 자신의 IP와 MAC주소를 알릴 목적으로 사용된다***
        - IP 주소 충돌 감지
            - 여러가지 이유로 내가 할당받은 IP를 다른사람이 사용하고 있을 수 있다
            - IP충돌로 통신이 안되는 것을 예방하기 위해 자신의 IP가 네트워크에서 사용되고 있는지 확인할 수 있다
            - GARP응답이 오면 해당 IP를 이미 사용 중인 단말이 있다는 의미이다

        - 상대방(동일한 서브넷)의 ARP테이블 갱신 
            - 가상 MAC주소를 사용하지 않는 데이터베이스 HA 솔루션에서 주로 사용한다
            - 데이터 베이스 HA는 두 데이터베이스 서버가 하나의 가상 IP주소로 서비스한다
                - 두 대중 한대만 동작하고 나머지는 대기한다
                - IP는 가상이지만 MAC주소는 실제 주소를 사다
            - ARP요청에 동작중인 데이터베이스가 응답한다
                - 동작하는 데이터베이스가 바뀌면 기존의 연결된 단말에 GARP패킷을 보내 변경된 정보를 갱신시킨다
            
            - 그러나 GARP패킷을 가로채는 기법등 보안상의 문제로 가상 MAC을 사용하는 HA솔루션이 많이 사용된다

        - 클러스터링, FHRP(VRRP, HSRP) 
            - 네트워크에 있는 스위치 장비의 MAC 테이블 갱신이 목적이다
            - FHRP와 같은 프로토콜들은 디폴트 게이트웨이에 장애발생시 외부통신이 안되는 문제를 해결한다
                - 두 대의 디폴트 게이트웨이 라우터가 한 대처럼 동작해 한쪽에 문제가 생겨도 다른 쪽에서 서비스를 지속하게 해준다

            - 클러스터링에서 가상 MAC주소를 사용하는 경우 ARP 테이블을 갱신할 필요가 없다
                - 하지만 클러스터링 중간에서 통신을 중계하는 스위치의 MAC테이블은 서버가 변경되었을 때 다시 가상의 MAC주소로 테이블을 갱신해줘야 한다

- RARP(Reverse ARP) : ARP의 필드의 내용을 변경해서 다른용도로 사용한다
    - 반대로 동작하는 ARP로 IP주소가 정해져 있지 않은 단말이 IP할당을 요청할 때 사용한다
        - 과거 네트워크 호스트의 주소 할당에 사용되었지만 제한된 기능으로 인해 BOOTP와 DHCP로 대체되어 사용되지 않는다
    

## 서브넷과 게이트웨이
- 로컬 네트워크와 원격지 네트워크의 통신은 동작방식이나 필요한 네트워크 장비가 모두 다르다
    - 게이트웨이 : 원격지 네트워크 통신에 사용하는 장비(3계층 장비:라우터, L3스위치)

- 서브넷,게이트웨이의 용도
    -  로컬 네트워크에서 ARP브로드캐스트를 사용할 수 있지만 브로드캐스트는 원격 네트워크에서 통신할 수 없다
        - 게이트 웨이를 통해 가능하다
        - 기본 게이트웨이(Default Gateway) : 게이트 웨이의 정보를 PC, 네트워크 장비에서 설정하는 항목
            - 기본 게이트웨이는 여러 네트워크와 연결되면서 적절한 경로를 지정해주는 역할을 한다
    
    - 통신하려는 목적지가 로컬 네트워크의 범위인지 확인하기 위해 서브넷 마스크가 사용된다
    
- 프록시 ARP
    - ARP에 대한 응답을 대행해 주는 기능이다

    - 원격지 통신은 기본 게이트 웨이를 통해서 통신할 수 있다
        - 기본 게이트웨이에 프록시ARP가 활성화 된 경우 원격지이더라도 로컬 네트워크에 ARP브로드캐스트를 보내 통신할 수 있다
            - 보통 라우터에 기본으로 활성화 되어있다
        
        - 프록시 ARP로 인해 장애요소가 생기기도 한다
            - 엉뚱한 ARP요청을 처리하거나 기본 게이트웨이가 잘못 입력되도 통신이 될 수 있다
        
- 2계층 통신(로컬 네트워크 통신) vs 3계층 통신(원격지 네트워크 통신)
    - L2 통신 : 통신을 연결하는 네트워크 장비에서 2계층까지만 정보를 확인해 통신하고 직접 브로드캐스트를 이용하는 통신
        - 로컬 네트워크는 라우터같은 3계층 네트워크 장비없이 통신이 가능하다
    
    - L3 통신 : 통신을 연결하는 네트워크 장비에서 3계층 정보까지 확인하는 통신
        - 외부 네트워크와 통신 할때 ARP요청을 기본 게이트웨이의 IP주소로 요청한다
        - 게이트웨이에서 ARP응답을 받으면 도착지 MAC주소에 기본 게이트웨이의 MAC주소를 저장하고 통신을 한다
            - 도착지 IP주소와 도착지 MAC주소가 가리키는 장치가 다르다