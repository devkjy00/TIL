## 4계층 장비의 특징
- 4계층 장비인 로드 밸런서, 방화벽과 같은 장비를 '세션 장비'라고 부르기도 한다
- 세션 장비 고려사항
    - 세션 테이블, Symmetric(대칭) 경로 요구, 로드 밸런서의 정보변경

## 로드 밸런서 
- 서버나 장비의 부하를 분산하기 위해 사용하는 장비
    - 트래픽을 분배, IP주소나 4계층 정보, 애플리케이션 정보를 확인, 수정한다
        - 웹, 애플리케이션, FWLB(FireWall Load Balancing), VPNL(VPN Load Balancing)등에서 사용한다
    - 스케일 아웃을 할 경우 로드밸런서는 대표 IP주소를 갖고 각 시스템을 관리한다
        - 스케일 아웃 : 작은 장비 여러대를 묶어서 더 큰 환경을 만드는 방법
    
    - L4 로드 밸런싱(일반적)
        - TCP, UDP 정보, 포트넘버를 기반으로 로드 밸런싱을 수행
        - 최근의 로드 밸런서는 L4, L7모두 지원한다
            - 4계층 정보로만 분산 처리하는 경우 L4로드 밸런싱이라고 한다
        
        
    - L7 로드 밸런싱
        - HTTP, FTP, SMTP와 같은 프로토콜 정보를 기반으로 로드 밸런싱을 수행
            - HTTP헤더 정보, URI같은 정보를 기반으로 부하를 분산한다
        
        - ADC라고 한다
        - 프록시 역할을 수행한다

- L4 스위치
    - 4계층에서 동작하면서 로드밸런서 기능이 있는 스위치
        - 부하 분산, 성능 최적화, 리다이랙션 기능 제공
        - 가장 대중적으로 사용된다
    
    - 가상 서버, 가상 IP, 리얼 서버, 리얼 IP를 설정하면 스위치가 가상IP를 리얼IP로 변경해준다
        - 가상 서버 : 사용자가 보는 실제 서비스
        - 가상 IP : 사용자가 접근하는 서비스 IP주소
        - 리얼 서버, IP : 실제 서비스를 수행하는 서버와 IP
    
- ADC(Application Delivery Controller) 
    - 어플리케이션 계층에서 동작, 계층 프로토콜의 헤더 내용을 이해하고 동작한다
        - 부하 분산, 정보 수정, 정보 필터링이 가능하다
        - 대부분의 ADC는 4계층에서 애플리케이션 계층까지 기능을 제공하고 장애극복, 리다이렉션기능을 제공한다
        - 프록시로 동작한다
    
- L4스위치 vs ADC
    - L4 스위치는 부하 분산 뿐만 아니라 최적화와 보안 기능도 제공 
        - TCP레벨의 간단한 DoS공격을 방어할 수 있다

    - ADC는 애플리케이션에 내용에 대한 분산, 리다이렉션, 최적화등 더 다양한 기능을 제공
        - 이미지, 정적 콘텐츠 캐싱을 통해 성능을 최적화한다 
        - 클라이언트 - ADC 구간을 SSL로 처리, ADC - server 구간을 HTTP로 처리 해준다

- *시스템 확장:스케일 업과 스케일 아웃*
    - 스케일 업 : 내부 컴포넌트 용량을 키우거나 더 큰 시스템으로 서비스를 옮기는 방법
        - 비용이 많이든다
    - 스케일 다운 : 더 작은 용량의 시스템으러 서비스를 옮기는 방법

    - 스케일 아웃 : 같은 용량의 시스템 여러개를 배치하는 방법
        - 로드 밸런서와 같은 외부 시스템이 필요하다
    - 스케일 인 : 여러개의 서비스를 합쳐 하나로 만드는 방법

## 방화벽
- 네트워크 중간에 트래픽을 정책 조건에 맞추어 허용하거나 차단하는 장비
    - 일반적으로 네트워크 3, 4계층에서 동작하고 세션을 인지, 관리하고 SPI(Stateful Packet Inspection)엔진을 기반으로 동작하는 장비를 방화벽이라고 부른다

- 패킷이 외부로 나갈 때 세션정보를 저장하고 참조해서 패킷이 외부에서 시작됬는지 내부에서 요청한 응답인지 검사한다

- *상태 테이블?, 세션 테이블?*
    - 패킷의 상태정보를 인지하는 장비의 경우 상태 테이블을 가지고있고 세션테이블이라고도 부른다

## 4계층 장비를 통과할 때의 유의점(세션 관리)
- 세션 장비는 세션 테이블을 통해 패킷을 변경, 최적화 또는 보안을 위해 포워드, 드롭 할 수 있다

- 세션 테이블 유지, 세션 정보 동기화
    - 통신이 시작되면 세션 장비는 세션 상태를 테이블에 기록한다
        - 통신이 정상 종료되지 않더라도 일정시간 정보를 유지한다
            - 공격을 막기위해 타임아웃값을 더 줄이기도 한다
        
        - 세션 장비의 타임아웃 값이 어플리케이션의 세션 타임아웃값보다 짧으면 통신에 문제가 생긴다
            - 양쪽의 어플리케이션의 통신이 연결된 상태여도 통신의 중간에 드롭된다 
        
    - 세션 장비 운영자 : 세션 장비에서 패킷 드롭 방지 방법
        1. 세션 만료 시간 증가
            - 애플리케이션의 세션 유지 시간보다 길도록 설정
            - 포트 번호나 IP주소마다 별도의 세션 만료 시간을 설정 할 수 있다
        
        2. 중간 패킷을 수용하도록 방화벽 설정
            - 보안이 취약해지기 때문에 좋지 않다
        
        3. 세션 장비에서 세션 타임아웃시 양 단말에 세션 종료 통보
            - 만료 시간을 동기화하기 위해 세션 정보만료(RST)를 통보한다
    
    - 개발자 : 애플리케이션에서 패킷 드롭 방지 방법
        1. 애플리케이션에서 주기적인 패킷 발생기능 추가
            - 중간에 통신이 없어도 일정 시간마다 양 단말 애플리케이션의 세션을 체크하는 더미패킷(Dummy Packet)을 보내서 세션을 유지
            - 최근 대부분의 플랫폼에서 이런 기능을 내장한다
        
- 비대칭 경로 문제
    - 비대치 경로(Asymmetric Path) : 회선 이중화로 경로가 2개 이상이 되서 Inbound, Outbound패킷의 경로가 다른 경우 
        - 세션 장비가 두대 이상이면 Inbound, Outbound패킷의 경로가 일정하지않아서 정상적으로 통신되지 않는다
 
    - 비대칭 경로가 생기지 않도록 경로를 디자인 하는 것이 가장 좋은 방법이다
        - 비대칭 경로를 처리하는 기능은 성능이나 보안을 저하시킨다
    
    - 비대칭 경로를 방화벽에서 처리하는 방법
        1. 세션 테이블을 동기화 
            - 두개의 장비가 하나의 장비처럼 동작하지만 패킷의 응답이 빠르면 동기화되지 못해서 드롭될 수 있다
            - 응답시간이 비교적 긴 인터넷 게이트웨이로 방화벽이 사용될 때 유용하다
        
        2. 세션 장비에서 보정하는 방법
            - MAC 리라이팅, 터널링 : 비대치 경로로 패킷이 오면 인바운드 패킷정보가 있는 경로로 보내 경로를 보정한다
        
- 하나의 통신에 두 개 이상의 세션이 사용 될 때의 고려사항
    - 특별한 목적으로 두개 이상의 세션을 만드는 경우 세션 장비도 이를 알아야 한다
    - 프로토콜의 구분
        - 데이터 프로토콜(데이터를 전달)
        - 컨트롤 프로토콜(세션을 제어)
        - 현대 프로토콜은 대부분 헤더나 메시지로 한번에 처리한다
        - 오래되거나 특별한 목적이 있는 프로토콜은 여전히 분리된 경우가 있다, FTP(File Transfer Protocol)
    
    - FTP
        - Active 모드 : 컨트롤 프로토콜은 클라이언트->서버 데이터 프로토콜은 서버->클라이언트 방향으로 통신한다
            - 작동 방식
                - 서버는 요청을 받으면 컨트롤 포트로 응답하고 데이터 포트로 데이터를 전송한다
                - 클라이언트는 데이터를 전달 받으면 데이터 포트로 응답한다
            - Active모드에 맞춰서 방화벽의 반대 방향도 열어줘야 한다
            - NET환경인 경우 ALG(Application Layer Gateway)기능을 동작 시켜야 한다
            
        - Passive 모드 : 컨트롤 프로토콜과 데이터 프로토콜의 방향이 같다
            - 방화벽이나 세션장비에 특별한 작업을 하지 않아도 동작한다
            - 데이터 다운로드를 위해서는 추가 포트를 열어줘야 한다